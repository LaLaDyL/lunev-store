const express = require('express');
const { query } = require('./config/database');

const app = express();
app.use(express.json());

// Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ CORS
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Headers', 'Content-Type');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
  next();
});

// Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°
app.get('/', (req, res) => {
  res.json({ 
    message: 'âœ… L-U-N-E-V Backend Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!',
    version: '1.0.0',
    endpoints: {
      products: 'GET /api/products',
      product_by_id: 'GET /api/products/1',
      register: 'POST /api/register',
      login: 'POST /api/login'
    }
  });
});

// Ð¢ÐµÑÑ‚ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
app.get('/test', async (req, res) => {
  try {
    const result = await query('SELECT NOW() as time');
    res.json({ 
      status: 'âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¸ Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚!',
      time: result.rows[0].time
    });
  } catch (error) {
    res.status(500).json({ 
      status: 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…',
      error: error.message 
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹
app.get('/api/products', async (req, res) => {
  try {
    const result = await query('SELECT * FROM products');
    res.json({
      status: 'success',
      count: result.rows.length,
      products: result.rows
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¿Ð¾ ID
app.get('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const result = await query('SELECT * FROM products WHERE id = $1', [id]);
    
    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
    }
    
    res.json({
      status: 'success',
      product: result.rows[0]
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ)
app.post('/api/register', async (req, res) => {
  try {
    const { email, password, firstName, lastName, phone } = req.body;
    
    console.log('Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ:', { email, firstName, lastName });
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
    const userExists = await query('SELECT * FROM users WHERE email = $1', [email]);
    if (userExists.rows.length > 0) {
      return res.status(400).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚' });
    }
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð±ÐµÐ· ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
    const result = await query(
      'INSERT INTO users (email, password, first_name, last_name, phone) VALUES ($1, $2, $3, $4, $5) RETURNING id, email, first_name, last_name',
      [email, password, firstName, lastName, phone]
    );
    
    res.json({
      status: 'success',
      message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½',
      user: result.rows[0]
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Ð’Ñ…Ð¾Ð´ (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹)
app.post('/api/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    console.log('Ð’Ñ…Ð¾Ð´:', { email });
    
    const result = await query(
      'SELECT id, email, first_name, last_name FROM users WHERE email = $1 AND password = $2',
      [email, password]
    );
    
    if (result.rows.length === 0) {
      return res.status(400).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ email Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }
    
    res.json({
      status: 'success',
      message: 'Ð’Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½',
      user: result.rows[0]
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log('ðŸš€ ==================================');
  console.log('ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ L-U-N-E-V Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
  console.log(`ðŸš€ ÐÐ´Ñ€ÐµÑ: http://localhost:${PORT}`);
  console.log('ðŸš€ ==================================');
  console.log('ðŸ“Š Ð¢ÐµÑÑ‚ Ð±Ð°Ð·Ñ‹: http://localhost:3000/test');
  console.log('ðŸ›ï¸ Ð¢Ð¾Ð²Ð°Ñ€Ñ‹: http://localhost:3000/api/products');
  console.log('ðŸ” Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ: POST http://localhost:3000/api/register');
  console.log('ðŸ” Ð’Ñ…Ð¾Ð´: POST http://localhost:3000/api/login');
});

// ================== ÐšÐžÐ Ð—Ð˜ÐÐ ==================

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get('/api/cart/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const result = await query(`
      SELECT c.*, p.name, p.price, p.image_url 
      FROM cart c 
      JOIN products p ON c.product_id = p.id 
      WHERE c.user_id = $1
    `, [userId]);
    
    res.json({
      status: 'success',
      cart: result.rows
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
app.post('/api/cart/add', async (req, res) => {
  try {
    const { userId, productId, quantity = 1, selectedMemory } = req.body;
    
    console.log('ðŸ“¦ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ:', { userId, productId, quantity, selectedMemory });
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ðµ
    const existingItem = await query(
      'SELECT * FROM cart WHERE user_id = $1 AND product_id = $2 AND selected_memory = $3',
      [userId, productId, selectedMemory || '']
    );
    
    if (existingItem.rows.length > 0) {
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾
      await query(
        'UPDATE cart SET quantity = quantity + $1 WHERE user_id = $2 AND product_id = $3 AND selected_memory = $4',
        [quantity, userId, productId, selectedMemory || '']
      );
      console.log('âœ… ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾');
    } else {
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€
      await query(
        'INSERT INTO cart (user_id, product_id, quantity, selected_memory) VALUES ($1, $2, $3, $4)',
        [userId, productId, quantity, selectedMemory || '']
      );
      console.log('âœ… Ð¢Ð¾Ð²Ð°Ñ€ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½');
    }
    
    res.json({
      status: 'success',
      message: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ'
    });
  } catch (error) {
    console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
    res.status(500).json({ error: error.message });
  }
});

// ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ðµ
app.put('/api/cart/update', async (req, res) => {
  try {
    const { userId, productId, quantity, selectedMemory } = req.body;
    
    console.log('ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹:', { userId, productId, quantity, selectedMemory });
    
    if (quantity <= 0) {
      // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€ ÐµÑÐ»Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ 0
      await query(
        'DELETE FROM cart WHERE user_id = $1 AND product_id = $2 AND selected_memory = $3',
        [userId, productId, selectedMemory || '']
      );
      console.log('ðŸ—‘ï¸ Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹');
    } else {
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾
      await query(
        'UPDATE cart SET quantity = $1 WHERE user_id = $2 AND product_id = $3 AND selected_memory = $4',
        [quantity, userId, productId, selectedMemory || '']
      );
      console.log('âœ… ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾:', quantity);
    }
    
    res.json({
      status: 'success',
      message: 'ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°'
    });
  } catch (error) {
    console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
app.delete('/api/cart/remove', async (req, res) => {
  try {
    const { userId, productId, selectedMemory } = req.body;
    
    console.log('ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹:', { userId, productId, selectedMemory });
    
    await query(
      'DELETE FROM cart WHERE user_id = $1 AND product_id = $2 AND selected_memory = $3',
      [userId, productId, selectedMemory || '']
    );
    
    console.log('âœ… Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½');
    
    res.json({
      status: 'success',
      message: 'Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹'
    });
  } catch (error) {
    console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ:', error);
    res.status(500).json({ error: error.message });
  }
});

// ================== Ð˜Ð—Ð‘Ð ÐÐÐÐžÐ• ==================

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get('/api/favorites/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const result = await query(`
      SELECT f.*, p.name, p.price, p.image_url 
      FROM favorites f 
      JOIN products p ON f.product_id = p.id 
      WHERE f.user_id = $1
    `, [userId]);
    
    res.json({
      status: 'success',
      favorites: result.rows
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ
app.post('/api/favorites/add', async (req, res) => {
  try {
    const { userId, productId } = req.body;
    
    console.log('â¤ï¸ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ:', { userId, productId });
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼
    const existingItem = await query(
      'SELECT * FROM favorites WHERE user_id = $1 AND product_id = $2',
      [userId, productId]
    );
    
    if (existingItem.rows.length > 0) {
      res.json({
        status: 'success',
        message: 'Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ¶Ðµ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼'
      });
    } else {
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€
      await query(
        'INSERT INTO favorites (user_id, product_id) VALUES ($1, $2)',
        [userId, productId]
      );
      console.log('âœ… Ð¢Ð¾Ð²Ð°Ñ€ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ');
      
      res.json({
        status: 'success',
        message: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ'
      });
    }
  } catch (error) {
    console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾
app.delete('/api/favorites/remove', async (req, res) => {
  try {
    const { userId, productId } = req.body;
    
    console.log('ðŸ’” Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾:', { userId, productId });
    
    await query(
      'DELETE FROM favorites WHERE user_id = $1 AND product_id = $2',
      [userId, productId]
    );
    
    console.log('âœ… Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾');
    
    res.json({
      status: 'success',
      message: 'Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾'
    });
  } catch (error) {
    console.log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ:', error);
    res.status(500).json({ error: error.message });
  }
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼
app.get('/api/favorites/check/:userId/:productId', async (req, res) => {
  try {
    const { userId, productId } = req.params;
    
    const result = await query(
      'SELECT * FROM favorites WHERE user_id = $1 AND product_id = $2',
      [userId, productId]
    );
    
    res.json({
      status: 'success',
      isFavorite: result.rows.length > 0
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});